# 分布式事物

##  什么是ACID



## 

## 什么是Base原则







## 什么是 TCC分布式事务

柔性事务，柔主要是相对于ACID的刚而言，让柔性事务只需要遵循base原则。而TCC是柔性事务的一种实现，TCC是三个首字母，Try-confirm-cancel，具体描述的是将整个操作分为上面的这三步。两个微服务间的同时进行Try，在Try的阶段会进行数据的校验，检查，资源的预创建，如果都成功就会分别进行Confirm，如果两者都成功则整个TCC事务完成。如果Confirm时有一个服务有问题，则会转向Cancel，相当于进行Confirm的逆操作。



##  TCC 优缺点

TCC优点：让应用自己定义数据库操作的粒度，使得降低锁冲突、提高吞吐量成为可能。

TCC不足之处：

- 对应用的侵入性强。业务逻辑的每个分支都需要实现try、confirm、cancel三个操作，应用侵入性较强，改造成本高。
- 实现难度较大。需要按照网络状态、系统故障等不同的失败原因实现不同的回滚策略。为了满足一致性的要求，confirm和cancel接口必须实现幂等。

## TCC 事务应用场景

我们通过用户下单使用余额+红包支付来看一下TCC事务的具体应用。

假设用户下单操作来自3个系统下单系统、资金账户系统、红包账户系统，下单成功需要同时调用资金账户服务和红包服务完成支付

假设购买商品1000元，使用账户红包200元，余额800元，确认支付。

- **Try操作**
  tryX 下单系统创建待支付订单
  tryY 冻结账户红包200元
  tryZ 冻结资金账户800元
- **Confirm操作**
  confirmX 订单更新为支付成功
  confirmY 扣减账户红包200元
  confirmZ 扣减资金账户800元
- **Cancel操作**
  cancelX 订单处理异常，资金红包退回，订单支付失败
  cancelY 冻结红包失败，账户余额退回，订单支付失败
  cancelZ 冻结余额失败，账户红包退回，订单支付失败